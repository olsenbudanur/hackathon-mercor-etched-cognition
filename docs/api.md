# API Documentation

This document provides detailed information about the API endpoints available in the EEG-Enhanced Language Model with Mixture-of-Experts project. The backend is built with FastAPI and provides several endpoints for token streaming, status monitoring, and debugging.

## Table of Contents

- [Base URL](#base-url)
- [Authentication](#authentication)
- [Endpoints](#endpoints)
  - [Add Tokens](#add-tokens)
  - [Stream Tokens](#stream-tokens)
  - [Clear Tokens](#clear-tokens)
  - [Toggle Test Data](#toggle-test-data)
  - [Get Status](#get-status)
  - [Debug Tokens](#debug-tokens)
- [Data Models](#data-models)
- [Error Handling](#error-handling)
- [Rate Limiting](#rate-limiting)
- [Examples](#examples)

## Base URL

All API endpoints are relative to the base URL:

```
http://localhost:8000
```

## Authentication

The API does not currently require authentication. It is designed for local development and testing.

## Endpoints

### Add Tokens

Adds tokens to the streaming queue.

**URL**: `/add-tokens`

**Method**: `POST`

**Request Body**:

```json
{
  "tokens": [
    {
      "token": "string",
      "expert": "string"
    }
  ]
}
```

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `tokens` | array | Array of token objects |
| `tokens[].token` | string | The text token generated by the language model |
| `tokens[].expert` | string | The expert that generated this token (simple, balanced, or complex) |

**Response**:

```json
{
  "status": "success",
  "tokens_added": 3
}
```

**Response Fields**:

| Name | Type | Description |
|------|------|-------------|
| `status` | string | Status of the operation (success or error) |
| `tokens_added` | integer | Number of tokens added to the queue |

**Status Codes**:

| Status Code | Description |
|-------------|-------------|
| 200 | Success |
| 422 | Validation Error (invalid request body) |

**Example**:

```bash
curl -X POST "http://localhost:8000/add-tokens" \
     -H "Content-Type: application/json" \
     -d '{
           "tokens": [
             {
               "token": "Hello",
               "expert": "simple"
             },
             {
               "token": " ",
               "expert": "balanced"
             },
             {
               "token": "world",
               "expert": "complex"
             }
           ]
         }'
```

### Stream Tokens

Streams tokens to the frontend using server-sent events.

**URL**: `/stream`

**Method**: `GET`

**Response**: Server-sent events with token data.

**Event Format**:

```
data: {"word": "Hello", "number": 1}
```

**Event Fields**:

| Name | Type | Description |
|------|------|-------------|
| `word` | string | The text token |
| `number` | integer | The color number corresponding to the expert (1-3) |

**Status Codes**:

| Status Code | Description |
|-------------|-------------|
| 200 | Success |

**Example**:

```javascript
// JavaScript client code
const eventSource = new EventSource('http://localhost:8000/stream');
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Received token:', data.word, 'Expert color:', data.number);
};
```

### Clear Tokens

Clears all tokens from the token queue.

**URL**: `/clear-tokens`

**Method**: `POST`

**Response**:

```json
{
  "status": "success",
  "message": "Token queue cleared"
}
```

**Response Fields**:

| Name | Type | Description |
|------|------|-------------|
| `status` | string | Status of the operation (success or error) |
| `message` | string | Description of the operation result |

**Status Codes**:

| Status Code | Description |
|-------------|-------------|
| 200 | Success |

**Example**:

```bash
curl -X POST "http://localhost:8000/clear-tokens"
```

### Toggle Test Data

Enables or disables random test data generation.

**URL**: `/toggle-test-data`

**Method**: `POST`

**Request Body**:

```json
{
  "enable": true
}
```

**Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `enable` | boolean | Whether to enable (true) or disable (false) test data generation |

**Response**:

```json
{
  "status": "success",
  "test_data_enabled": true
}
```

**Response Fields**:

| Name | Type | Description |
|------|------|-------------|
| `status` | string | Status of the operation (success or error) |
| `test_data_enabled` | boolean | Current state of test data generation |

**Status Codes**:

| Status Code | Description |
|-------------|-------------|
| 200 | Success |
| 422 | Validation Error (invalid request body) |

**Example**:

```bash
curl -X POST "http://localhost:8000/toggle-test-data" \
     -H "Content-Type: application/json" \
     -d '{"enable": true}'
```

### Get Status

Gets the current status of the server.

**URL**: `/status`

**Method**: `GET`

**Response**:

```json
{
  "queue_size": 10,
  "test_data_enabled": false
}
```

**Response Fields**:

| Name | Type | Description |
|------|------|-------------|
| `queue_size` | integer | Number of tokens currently in the queue |
| `test_data_enabled` | boolean | Whether test data generation is enabled |

**Status Codes**:

| Status Code | Description |
|-------------|-------------|
| 200 | Success |

**Example**:

```bash
curl -X GET "http://localhost:8000/status"
```

### Debug Tokens

Gets a dump of recently processed tokens for debugging.

**URL**: `/debug-tokens`

**Method**: `GET`

**Query Parameters**:

| Name | Type | Description |
|------|------|-------------|
| `limit` | integer | Maximum number of tokens to return (default: 50) |

**Response**:

```json
{
  "queue_size": 15,
  "tokens": [
    {
      "word": "Hello",
      "number": 1
    },
    {
      "word": " ",
      "number": 2
    },
    {
      "word": "world",
      "number": 3
    }
  ],
  "test_data_enabled": false
}
```

**Response Fields**:

| Name | Type | Description |
|------|------|-------------|
| `queue_size` | integer | Number of tokens currently in the queue |
| `tokens` | array | Array of token objects |
| `tokens[].word` | string | The text token |
| `tokens[].number` | integer | The color number corresponding to the expert (1-3) |
| `test_data_enabled` | boolean | Whether test data generation is enabled |

**Status Codes**:

| Status Code | Description |
|-------------|-------------|
| 200 | Success |

**Example**:

```bash
curl -X GET "http://localhost:8000/debug-tokens?limit=10"
```

## Data Models

### TokenData

```json
{
  "token": "string",
  "expert": "string"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `token` | string | The text token generated by the language model |
| `expert` | string | The expert that generated this token (simple, balanced, or complex) |

### TokenStreamData

```json
{
  "tokens": [
    {
      "token": "string",
      "expert": "string"
    }
  ]
}
```

| Field | Type | Description |
|-------|------|-------------|
| `tokens` | array | Array of TokenData objects |

## Error Handling

The API uses standard HTTP status codes to indicate the success or failure of a request.

### Common Error Codes

| Status Code | Description |
|-------------|-------------|
| 400 | Bad Request - The request was malformed |
| 404 | Not Found - The requested resource was not found |
| 422 | Validation Error - The request body failed validation |
| 500 | Internal Server Error - An unexpected error occurred |

### Error Response Format

```json
{
  "detail": [
    {
      "loc": ["body", "tokens", 0, "token"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

## Rate Limiting

The API does not currently implement rate limiting. It is designed for local development and testing.

## Examples

### Python Client Example

```python
import requests
import json
import sseclient

# Add tokens to the queue
def add_tokens(tokens):
    response = requests.post(
        "http://localhost:8000/add-tokens",
        json={"tokens": tokens}
    )
    return response.json()

# Stream tokens from the server
def stream_tokens():
    response = requests.get("http://localhost:8000/stream", stream=True)
    client = sseclient.SSEClient(response)
    for event in client.events():
        yield json.loads(event.data)

# Example usage
tokens = [
    {"token": "Hello", "expert": "simple"},
    {"token": " ", "expert": "balanced"},
    {"token": "world", "expert": "complex"}
]

# Add tokens
result = add_tokens(tokens)
print(f"Added {result['tokens_added']} tokens")

# Stream tokens
for token in stream_tokens():
    print(f"Received token: {token['word']}, Expert: {token['number']}")
    # Break after receiving 5 tokens
    if token['word'] == "world":
        break
```

### JavaScript Client Example

```javascript
// Add tokens to the queue
async function addTokens(tokens) {
  const response = await fetch('http://localhost:8000/add-tokens', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ tokens })
  });
  return response.json();
}

// Stream tokens from the server
function streamTokens(callback) {
  const eventSource = new EventSource('http://localhost:8000/stream');
  eventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    callback(data);
  };
  return eventSource;
}

// Example usage
const tokens = [
  { token: 'Hello', expert: 'simple' },
  { token: ' ', expert: 'balanced' },
  { token: 'world', expert: 'complex' }
];

// Add tokens
addTokens(tokens)
  .then(result => console.log(`Added ${result.tokens_added} tokens`))
  .catch(error => console.error('Error adding tokens:', error));

// Stream tokens
const eventSource = streamTokens(data => {
  console.log(`Received token: ${data.word}, Expert: ${data.number}`);
  
  // Close the connection after receiving the 'world' token
  if (data.word === 'world') {
    eventSource.close();
  }
});
```
